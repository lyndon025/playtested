---
import SiteOptions from "../site.config.mjs";

interface Props {
    type: "in-article" | "sidebar" | "footer";
    provider?: "adsense" | "carbon" | "adsterra";
    class?: string;
}

const { type, provider, class: className = "" } = Astro.props;
const ads = (SiteOptions as any).ads;

const isAdSense =
    (provider === "adsense" || (!provider && ads.adSense.enabled)) &&
    ads.adSense.enabled;
const isCarbon =
    (provider === "carbon" || (!provider && ads.carbonAds.enabled)) &&
    ads.carbonAds.enabled;
const isAdsterra =
    (provider === "adsterra" || (!provider && ads.adsterra.enabled)) &&
    ads.adsterra.enabled;

const isAdsterraNative = isAdsterra && ads.adsterra.nativeBannerEnabled;
const isAdsterraFooter = isAdsterra && ads.adsterra.footerBannerEnabled;

// Minimum heights to prevent CLS
const minHeights = {
    "in-article": "min-h-[280px]",
    sidebar: "min-h-[600px]",
    footer: "min-h-[90px]",
};
---

{
    isAdSense && (
        <div
            class={`ad-container adsense-container my-8 mx-auto text-center overflow-hidden ${minHeights[type]} ${className}`}
        >
            <ins
                class="adsbygoogle"
                style={
                    type === "footer"
                        ? "display:inline-block;width:728px;height:90px"
                        : "display:block; text-align:center;"
                }
                data-ad-layout={
                    type === "in-article" ? "in-article" : undefined
                }
                data-ad-format={type === "footer" ? undefined : "fluid"}
                data-ad-client={ads.adSense.clientId}
                data-ad-slot={
                    type === "footer"
                        ? ads.adSense.footerUnitId
                        : ads.adSense.articleUnitId
                }
            />
            <script is:inline>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    )
}

{
    isAdsterra && (
        <div
            class={`ad-container adsterra-container my-8 mx-auto text-center overflow-hidden ${minHeights[type]} ${className}`}
        >
            {type === "in-article" && isAdsterraNative && (
                <div id={`container-${ads.adsterra.nativeBannerId}`}></div>
                <script is:inline type="text/javascript" src={`https://pl28747193.effectivegatecpm.com/${ads.adsterra.nativeBannerId}/invoke.js`}></script>
            )}
            {type === "footer" && isAdsterraFooter && (
                <script is:inline type="text/javascript" define:vars={{ id: ads.adsterra.footerBannerId }}>
                    atOptions = {
                        'key' : id,
                        'format' : 'js',
                        'height' : 90,
                        'width' : 728,
                        'params' : {}
                    };
                </script>
                <script is:inline type="text/javascript" src={`https://www.highperformanceformat.com/${ads.adsterra.footerBannerId}/invoke.js`}></script>
            )}
        </div>
    )
}

{
    isCarbon && (
        <div
            class={`ad-container carbon-container my-8 mx-auto flex justify-center ${minHeights[type]} ${className}`}
            id="carbon-ad-wrapper"
        >
            <script
                is:inline
                async
                type="text/javascript"
                src={`//cdn.carbonads.com/carbon.js?serve=${ads.carbonAds.serve}&placement=${ads.carbonAds.placement}`}
                id="_carbonads_js"
            />
        </div>
    )
}

<style is:global>
    /* AdSense specific styling */
    .adsense-container {
        width: 100%;
        max-width: 100%;
    }

    /* Carbon Ads specific styling - can be tweaked based on their default output */
    #carbonads {
        display: flex;
        max-width: 330px;
        background-color: hsl(0, 0%, 98%);
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.1);
        font-family:
            -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans,
            Ubuntu, Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .dark #carbonads {
        background-color: hsl(222, 47%, 11%);
        border: 1px solid hsl(217, 32%, 17%);
    }

    #carbonads a {
        color: inherit;
        text-decoration: none;
    }

    #carbonads a:hover {
        color: inherit;
    }

    #carbonads span {
        position: relative;
        display: block;
        overflow: hidden;
    }

    .carbon-img {
        display: block;
        margin-bottom: 8px;
        line-height: 1;
    }

    .carbon-img img {
        display: block;
        margin: 0 auto;
    }

    .carbon-text {
        display: block;
        padding: 0 10px 10px;
        font-size: 14px;
        line-height: 1.45;
        text-align: left;
    }

    .carbon-poweredby {
        display: block;
        padding: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        font-size: 9px;
        line-height: 0;
    }
</style>
