---
import { getCollection } from "astro:content";

interface Props {
  id?: string;
  title: string;
  description?: string;
  thumb?: string;
  url?: URL;
  score?: number | string;
  author?: string;
  type?: "article" | "home";
}

const {
  id = "review-card-element",
  title,
  description,
  thumb,
  url = Astro.url,
  score,
  author,
  type = "article",
} = Astro.props;

const qrValue = url.href;

// Fetch featured articles for Home card from BOTH collections
let featuredArticles: any[] = [];
if (type === "home") {
  const articles = await getCollection("article");
  const submissions = await getCollection("submissions");
  const allPosts = [...articles, ...submissions];
  featuredArticles = allPosts
    .filter((p) => p.data.featured)
    .sort(
      (a, b) =>
        new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf(),
    )
    .slice(0, 3);
}
---

<div
  id={id}
  class="fixed left-0 top-0 w-[600px] h-[315px] bg-slate-900 text-white overflow-hidden font-sans border border-slate-700 shadow-2xl z-[-50] opacity-0 pointer-events-none"
  style="font-family: 'Inter', sans-serif;"
>
  <div class="relative w-full h-full flex flex-col bg-slate-900">
    <!-- Background Image with Overlay -->
    {
      thumb && (
        <div class="absolute inset-0 z-0 opacity-30">
          <img
            src={thumb}
            class="w-full h-full object-cover"
            alt="Background"
            crossorigin="anonymous"
            loading="eager"
          />
        </div>
      )
    }

    <!-- Gradient Overlay -->
    <div
      class="absolute inset-0 z-10 bg-gradient-to-t from-slate-950 via-slate-900/80 to-transparent"
    >
    </div>

    <!-- Content Container -->
    <div class="relative z-20 flex flex-col h-full p-6">
      <!-- TOP BAR -->
      <div class="flex justify-between items-start w-full gap-4 shrink-0 mb-2">
        <div class="flex items-center gap-3">
          {/* Home Specific: QR on top left BEFORE branding */}
          {
            type === "home" && (
              <div class="bg-white p-0.5 rounded shadow-sm shrink-0">
                <div class="card-qr-code" data-url={qrValue} />
              </div>
            )
          }

          <!-- Branding -->
          <div
            class="text-xl font-bold tracking-tight text-blue-400 whitespace-nowrap"
          >
            PlayTested.net
          </div>
        </div>

        {/* Article Specific: Scan text and QR on top right */}
        {
          type === "article" && (
            <div class="flex items-center gap-3 ml-auto">
              <span class="text-[10px] text-gray-300 font-bold tracking-widest uppercase text-right leading-tight">
                Scan to read
                <br />
                full review
              </span>
              <div class="bg-white p-0.5 rounded shadow-sm shrink-0">
                <div class="card-qr-code" data-url={qrValue} />
              </div>
            </div>
          )
        }
      </div>

      <!-- MIDDLE / BOTTOM AREA -->
      <div class="flex-1 flex flex-col min-h-0">
        {/* Home Layout */}
        {
          type === "home" && (
            <div class="flex flex-col h-full justify-end">
              {/* Description - Added margin top for spacing from QR, and margin bottom for spacing from featured */}
              {description && (
                <div class="my-auto pb-2">
                  <p class="text-sm text-gray-200 leading-relaxed font-medium text-balance drop-shadow-md whitespace-normal break-words">
                    {description}
                  </p>
                </div>
              )}

              {/* Featured Articles */}
              {featuredArticles.length > 0 && (
                <div class="flex gap-3 h-[155px] shrink-0 mt-auto">
                  {featuredArticles.map((article) => (
                    <div class="flex-1 bg-slate-800/90 rounded border border-slate-700/50 backdrop-blur-md shadow-lg overflow-hidden flex flex-col relative group">
                      {article.data.thumb && (
                        <div class="h-14 shrink-0 w-full relative">
                          <img
                            src={article.data.thumb}
                            class="w-full h-full object-cover opacity-90"
                            alt={article.data.title}
                            crossorigin="anonymous"
                            loading="eager"
                          />
                        </div>
                      )}
                      <div class="p-2 flex-1 flex flex-col min-h-0">
                        {/* Title: Limit to 2 lines */}
                        <div class="text-[10px] font-bold leading-tight text-white mb-1 line-clamp-2">
                          {article.data.title}
                        </div>
                        {/* Description: explicitly styled to wrap */}
                        <p
                          class="text-[9px] text-gray-400 leading-normal whitespace-normal break-words overflow-hidden"
                          style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical;"
                        >
                          {article.data.description}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )
        }

        {/* Article Layout (Bottom Half) */}
        {
          type === "article" && (
            <div class="mt-auto flex flex-col gap-3">
              {/* Title and Score Row */}
              <div class="flex items-start gap-4 w-full">
                {/* Title takes available space and wraps */}
                <h2 class="text-2xl font-bold leading-tight text-white flex-1 drop-shadow-lg breaking-words whitespace-normal">
                  {title}
                </h2>

                {/* Score */}
                {score && (
                  <div class="flex items-center justify-center bg-blue-600 px-3 py-1 rounded-md text-xl font-black text-white shadow-lg shrink-0 mt-1">
                    {score}
                  </div>
                )}
              </div>

              {/* Description - Explicitly enforcing wrapping */}
              {description && (
                <div class="w-full">
                  <p
                    class="text-base text-gray-200 leading-snug drop-shadow-md break-words whitespace-normal"
                    style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;"
                  >
                    {description}
                  </p>
                </div>
              )}
            </div>
          )
        }
      </div>
    </div>
  </div>
</div>

<script>
  import QRCode from "qrcode";

  function renderQRs() {
    const qrContainers = document.querySelectorAll(".card-qr-code");
    qrContainers.forEach((container) => {
      if (container.hasChildNodes()) return;

      const url = (container as HTMLElement).dataset.url;
      if (url) {
        QRCode.toDataURL(url, {
          width: 52,
          margin: 0,
          color: { dark: "#000000", light: "#ffffff" },
        })
          .then((dataUrl) => {
            const img = document.createElement("img");
            img.src = dataUrl;
            img.alt = "QR Code";
            img.className = "w-[52px] h-[52px] block"; // Matches width option
            container.appendChild(img);
          })
          .catch((err) => console.error("QR Error", err));
      }
    });
  }

  // Initial and after-swap
  renderQRs();
  document.addEventListener("astro:after-swap", renderQRs);
</script>
