---
import SiteOptions from "../site.config.mjs";
import { Image } from "astro:assets";
export interface Props {
  showTitle?: boolean;
}
const { showTitle = true } = Astro.props;
---

<!-- No-FOUC theme bootstrap -->
<script is:inline>
  (function () {
    try {
      const stored = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;
      const initial = stored || (systemPrefersDark ? "dark" : "light");
      if (initial === "dark") document.documentElement.classList.add("dark");
      else document.documentElement.classList.remove("dark");
      document.documentElement.setAttribute("data-theme", initial);
    } catch {}
  })();
</script>

<header class="mb-4 relative z-50">
  <div
    class="relative px-4 mt-2 flex items-center justify-center sm:justify-start lg:justify-between lg:px-0"
  >
    <!-- Hamburger (mobile only) -->
    <button
      id="hamburger"
      class="absolute left-4 p-2 sm:static sm:mr-4 lg:hidden"
      aria-label="Open menu"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-gray-800 dark:text-gray-100"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <!-- Logo + Title -->
    <div
      class="flex flex-col sm:flex-row items-center text-center sm:text-left mx-auto sm:mx-0"
    >
      <a href="/" class="flex items-center space-x-4 mt-2 md:mt-8">
        <Image
          src="/images/logo02.avif"
          alt="Logo"
          width={96}
          height={96}
          loading="eager"
          class="w-12 h-12 md:w-24 md:h-24 rounded-full object-cover border border-gray-200 dark:border-gray-700 shadow hover:opacity-80 transition-opacity"
        />
        {
          showTitle && (
            <div>
              <h1 class="text-lg md:text-4xl font-bold tracking-tight hover:opacity-80 transition-opacity">
                {SiteOptions.siteTitle}
              </h1>
              <p
                class="hidden sm:block text-sm md:text-lg text-gray-900 dark:text-gray-400 font-light mb-2 md:mb-0 max-w-[580px] md:max-w-none"
                set:html={SiteOptions.siteSubTitle}
              />
            </div>
          )
        }
      </a>
    </div>

    <!-- Single theme button that repositions by breakpoint -->
    <button
      id="theme-toggle"
      aria-label="Toggle theme"
      class="absolute right-4 p-2 sm:static sm:ml-auto rounded-md text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors"
    >
      <!-- One SVG. We swap the <path> d attribute -->
      <svg
        id="theme-icon"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-5 h-5"
      >
        <path
          id="theme-path"
          stroke-linecap="round"
          stroke-linejoin="round"
          d=""></path>
      </svg>
    </button>
  </div>

  <!-- Nav -->
  <div id="nav-container" class="relative">
    <nav
      id="nav-links"
      class="absolute top-[60px] lg:top-[20px] left-0 right-0 w-full lg:w-full flex flex-col lg:flex-row lg:items-center gap-4 p-4 lg:p-0 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 shadow-md lg:bg-transparent lg:dark:bg-transparent lg:border-none lg:shadow-none lg:relative z-40 transition-all duration-300 ease-in-out opacity-0 -translate-y-4 pointer-events-none lg:opacity-100 lg:translate-y-0 lg:pointer-events-auto lg:flex"
    >
      <div class="flex flex-col lg:flex-row lg:items-center gap-2 lg:gap-4">
        <a href="/" class="btn-tag">Home</a>
        <a href="/category/review/" class="btn-tag">Reviews</a>
        <a href="/category/tech/" class="btn-tag">Tech</a>
        <a href="/category/write-up/" class="btn-tag">Write-ups</a>

        <div class="relative">
          <button
            id="platformToggle"
            class="btn-tag w-full lg:w-auto text-left"
          >
            Platforms ▾
          </button>
          <div
            id="platformDropdown"
            class="absolute left-0 top-full mt-2 w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-md shadow-lg z-20 transform scale-y-0 opacity-0 origin-top transition-all duration-200 pointer-events-none"
          >
            <a
              href="/tag/pc/"
              class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
              >PC</a
            >
            <a
              href="/tag/console/"
              class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
              >Console</a
            >
            <a
              href="/tag/mobile/"
              class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
              >Mobile</a
            >
          </div>
        </div>

        <div class="relative">
          <button id="aiToggle" class="btn-tag w-full lg:w-auto text-left">
            AI Features ▾
          </button>
          <div
            id="aiDropdown"
            class="absolute left-0 top-full mt-2 w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-600 rounded-md shadow-lg z-20 transform scale-y-0 opacity-0 origin-top transition-all duration-200 pointer-events-none"
          >
            <button
              id="nav-chat-btn"
              class="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
            >
              AI Chatbot
            </button>
            <a
              href="/ai/recommend/"
              class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
              >AI Recommend</a
            >
            <a
              href="/ai/compare/"
              class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700"
              >AI Compare</a
            >
          </div>
        </div>
      </div>

      <div
        class="flex flex-col lg:flex-row lg:items-center gap-2 lg:gap-3 ml-auto w-full lg:w-auto"
      >
        <a href="/about/" class="btn-tag w-full lg:w-auto">About The Site</a>

        <div class="relative w-full lg:w-[300px]">
          <input
            type="text"
            id="global-search-input"
            placeholder="Search articles..."
            class="w-full py-2 pl-4 pr-10 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <button
            id="global-search-btn"
            type="button"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-md dark:bg-gray-600 bg-blue-100 text-white-600 hover:bg-blue-200 hover:text-blue-700 transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-4.35-4.35m1.1-5.65a7.5 7.5 0 11-15.001 0 7.5 7.5 0 0115.001 0z"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </nav>
  </div>

  <script is:inline>
    // Core theme manager
    const Theme = (() => {
      const sunPath =
        "M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z";
      const moonPath =
        "M21.752 15.002A9.72 9.72 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998Z";

      const get = () =>
        document.documentElement.getAttribute("data-theme") || "light";
      const set = (t, persist = true) => {
        document.documentElement.classList.toggle("dark", t === "dark");
        document.documentElement.setAttribute("data-theme", t);
        if (persist) localStorage.setItem("theme", t);
        setGiscusTheme(t === "dark" ? "dark_dimmed" : "light");

        syncIcon();
        syncAria();
      };

      const toggle = () => set(get() === "dark" ? "light" : "dark");

      const syncIcon = () => {
        const isDark = get() === "dark";
        const path = document.getElementById("theme-path");
        if (path) path.setAttribute("d", isDark ? sunPath : moonPath);
      };

      const syncAria = () => {
        const btn = document.getElementById("theme-toggle");
        if (btn) {
          const isDark = get() === "dark";
          btn.setAttribute("aria-pressed", String(isDark));
          btn.title = isDark ? "Switch to light theme" : "Switch to dark theme";
        }
      };

      return { get, set, toggle, syncIcon, syncAria };
    })();

    function setupTheme() {
      // Re-apply theme from storage to ensure persistence across transitions
      const stored = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)",
      ).matches;
      const current = stored || (systemPrefersDark ? "dark" : "light");

      // Use the internal set method but maybe don't need to re-write storage every time,
      // but 'set' does minimal work so it's fine.
      Theme.set(current, false); // false = don't overwrite storage, just sync DOM

      Theme.syncIcon();
      Theme.syncAria();
      // Delay to ensure frame exists
      setTimeout(
        () => setGiscusTheme(current === "dark" ? "dark_dimmed" : "light"),
        0,
      );

      // Wire up button
      const btn = document.getElementById("theme-toggle");
      // Remove old listener to prevent duplicates if navigating
      const newBtn = btn?.cloneNode(true);
      if (btn && newBtn) {
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener("click", () => Theme.toggle());
      }
    }

    function setupMobileMenu() {
      const nav = document.getElementById("nav-links");
      const hamburger = document.getElementById("hamburger");

      if (hamburger && nav) {
        // Clean up old listeners not needed as we replace or it's a fresh page
        hamburger.onclick = () => {
          const isClosed = nav.classList.contains("opacity-0");
          if (isClosed) {
            // Open it
            nav.classList.remove(
              "opacity-0",
              "-translate-y-4",
              "pointer-events-none",
            );
            nav.classList.add(
              "opacity-100",
              "translate-y-0",
              "pointer-events-auto",
            );
          } else {
            // Close it
            nav.classList.remove(
              "opacity-100",
              "translate-y-0",
              "pointer-events-auto",
            );
            nav.classList.add(
              "opacity-0",
              "-translate-y-4",
              "pointer-events-none",
            );
          }
        };
      }
    }

    function setupDropdown() {
      const bindDropdown = (toggleId, menuId) => {
        const toggleBtn = document.getElementById(toggleId);
        const dropdown = document.getElementById(menuId);

        if (toggleBtn && dropdown) {
          toggleBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent closing immediately
            // Close other dropdowns? Optional. But let's toggle current.

            // Simple toggle
            dropdown.classList.toggle("scale-y-100");
            dropdown.classList.toggle("opacity-100");
            dropdown.classList.toggle("scale-y-0");
            dropdown.classList.toggle("opacity-0");
            dropdown.classList.toggle("pointer-events-none");
          };
        }
        return { toggleBtn, dropdown };
      };

      const platforms = bindDropdown("platformToggle", "platformDropdown");
      const aiFeatures = bindDropdown("aiToggle", "aiDropdown");

      // Global click handler to close ALL dropdowns if clicked outside
      document.addEventListener("click", (e) => {
        const close = (obj) => {
          if (obj.toggleBtn && obj.dropdown) {
            if (
              !obj.toggleBtn.contains(e.target) &&
              !obj.dropdown.contains(e.target)
            ) {
              // Only close if it's open (has opacity-100)
              if (obj.dropdown.classList.contains("opacity-100")) {
                obj.dropdown.classList.remove("scale-y-100", "opacity-100");
                obj.dropdown.classList.add(
                  "scale-y-0",
                  "opacity-0",
                  "pointer-events-none",
                );
              }
            }
          }
        };
        close(platforms);
        close(aiFeatures);
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById("global-search-input");
      const searchBtn = document.getElementById("global-search-btn");

      if (searchInput) {
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const q = encodeURIComponent(searchInput.value.trim());
            if (q) window.location.href = `/search/?q=${q}`;
          }
        });
      }

      if (searchBtn && searchInput) {
        searchBtn.addEventListener("click", () => {
          const q = encodeURIComponent(searchInput.value.trim());
          if (q) window.location.href = `/search/?q=${q}`;
        });
      }
    }

    function setupNavChat() {
      const btn = document.getElementById("nav-chat-btn");
      if (btn) {
        btn.onclick = (e) => {
          e.preventDefault();
          // Direct call to avoid event detail loss
          if (window["_playtestedToggleChat"]) {
            window["_playtestedToggleChat"]("center");
          }

          // Also close mobile menu if open
          const nav = document.getElementById("nav-links");
          if (nav && !nav.classList.contains("opacity-0")) {
            nav.classList.remove(
              "opacity-100",
              "translate-y-0",
              "pointer-events-auto",
            );
            nav.classList.add(
              "opacity-0",
              "-translate-y-4",
              "pointer-events-none",
            );
          }
        };
      }
    }

    // Run on every page load (including View Transitions)
    document.addEventListener("astro:page-load", () => {
      setupTheme();
      setupMobileMenu();
      setupDropdown();
      setupSearch();
      setupNavChat();
    });

    // Also need to handle resize for theme icon sync
    window.addEventListener("resize", Theme.syncIcon);

    // React to OS theme changes
    try {
      const mq = window.matchMedia("(prefers-color-scheme: dark)");
      mq.addEventListener?.("change", (e) => {
        const stored = localStorage.getItem("theme");
        if (!stored) Theme.set(e.matches ? "dark" : "light", false);
      });
    } catch {}
  </script>

  <script is:inline>
    function setGiscusTheme(theme) {
      const frame = document.querySelector("iframe.giscus-frame");
      frame?.contentWindow?.postMessage(
        { giscus: { setConfig: { theme } } },
        "https://giscus.app",
      );
    }
  </script>
</header>
