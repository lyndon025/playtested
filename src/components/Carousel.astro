---
export interface Props {
  images: string[];
  caption?: string;
}

const { images, caption } = Astro.props as Props;
const id = `carousel-${Math.random().toString(36).substring(2, 9)}`;
const imgsJSON = JSON.stringify(images);
---

{images.length > 0 && (
  <div
    id={id}
    data-current="0"
    class="w-full max-w-[900px] mx-auto"
  >
    <!-- Main Image with fixed aspect ratio -->
    <div class="relative rounded-lg w-full">
      <img
        src={images[0]}
        alt=""
        class="main-image w-full h-auto max-h-[900px] object-contain rounded-lg opacity-0 transition-opacity duration-500 ease-in-out"
        onload="this.classList.add('opacity-100')"
      />
    </div>

    <!-- Thumbnails -->
    <div class="flex flex-wrap justify-center gap-2 mt-2">
      {images.map((src, i) => (
        <img
          key={i}
          src={src}
          alt=""
          data-index={i}
          onclick={`(() => {
            const c = document.getElementById('${id}');
            const m = c.querySelector('.main-image');
            m.classList.remove('opacity-100');
            m.classList.add('opacity-0');
            m.onload = () => m.classList.add('opacity-100');
            c.dataset.current = ${i};
            m.src = '${images[i]}';
          })()`}
          class="thumbnail w-24 h-24 object-cover rounded cursor-pointer opacity-50 border border-transparent hover:opacity-75 transition-opacity duration-200"
        />
      ))}
    </div>

    <!-- Optional Caption -->
    {caption && (
      <div class="mt-4 text-center text-gray-700 dark:text-gray-300">
        {caption}
      </div>
    )}

    <!-- Lightbox Modal -->
    <div
      id={`${id}-lightbox`}
      class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0 cursor-zoom-out"
      onclick={`(() => {
        const lb = document.getElementById('${id}-lightbox');
        lb.classList.remove('opacity-100');
        lb.classList.add('opacity-0');
        setTimeout(() => lb.classList.add('hidden'), 300);
      })()`}
    >
      <img
        id={`${id}-lightbox-img`}
        src=""
        alt=""
        class="max-w-[95vw] max-h-[95vh] object-contain shadow-2xl rounded-lg"
      />
    </div>

    <script define:vars={{ id }}>
      // Attach click listener to main-image for lightbox
      // We use a script here to keep the inline onclick cleaner or just use simple logic
      const carousel = document.getElementById(id);
      if (carousel) {
        const mainImg = carousel.querySelector('.main-image');
        const lightbox = document.getElementById(`${id}-lightbox`);
        const lightboxImg = document.getElementById(`${id}-lightbox-img`);

        if (mainImg && lightbox && lightboxImg) {
          mainImg.style.cursor = 'zoom-in';
          mainImg.addEventListener('click', () => {
             lightboxImg.src = mainImg.src;
             lightbox.classList.remove('hidden');
             // Small delay to allow display:block to apply before opacity transition
             requestAnimationFrame(() => {
                lightbox.classList.remove('opacity-0');
                lightbox.classList.add('opacity-100');
             });
          });
        }
      }
    </script>
  </div>
)}
