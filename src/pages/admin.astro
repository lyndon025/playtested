---
// Determine config file based on environment
const configUrl = import.meta.env.DEV ? "/config.local.yml" : "/config.yml";
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  </head>
  <body>
    <!-- Decap CMS Script -->
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    
    <!-- Custom preview templates -->
    <script src="/admin/index.js" type="module"></script>
    
    <!-- Debug and Initialize -->
    <script>
      console.log('Admin page loaded');
      console.log('Environment:', {
        isDev: import.meta.env.DEV,
        configUrl: '{configUrl}',
        currentUrl: window.location.href
      });
      
      // Debug OAuth messages
      window.addEventListener('message', function(event) {
        console.log('ðŸ” Message received:', {
          data: event.data,
          origin: event.origin,
          type: typeof event.data
        });
        
        // Log authorization messages specifically
        if (event.data && typeof event.data === 'object' && event.data.type) {
          if (event.data.type.includes('authorization:github')) {
            console.log('âœ… GitHub OAuth message:', event.data);
          }
        } else if (typeof event.data === 'string' && event.data.includes('authorization:github')) {
          console.log('âœ… GitHub OAuth string message:', event.data);
        }
      });
      
      // Initialize CMS with explicit config
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸš€ Initializing Decap CMS...');
        
        // Load config file and initialize
        fetch('{configUrl}')
          .then(response => {
            console.log('Config fetch response:', response.status, response.statusText);
            if (!response.ok) {
              throw new Error(`Config file not found: ${response.status}`);
            }
            return response.text();
          })
          .then(configText => {
            console.log('âœ… Config loaded successfully');
            
            // Initialize CMS
            if (window.CMS) {
              CMS.init().then(() => {
                console.log('âœ… CMS initialized successfully');
              }).catch((error) => {
                console.error('âŒ CMS initialization error:', error);
              });
            } else {
              console.error('âŒ CMS not loaded');
            }
          })
          .catch(error => {
            console.error('âŒ Config loading error:', error);
            console.log('Trying to initialize without explicit config...');
            
            if (window.CMS) {
              CMS.init({
                config: {
                  load_config_file: true
                }
              }).then(() => {
                console.log('âœ… CMS initialized with load_config_file');
              }).catch((error) => {
                console.error('âŒ CMS initialization failed completely:', error);
              });
            }
          });
      });
      
      // Additional debugging for auth flow
      console.log('ðŸ”§ Setting up auth debugging...');
      
      // Log when auth popup opens
      const originalOpen = window.open;
      window.open = function(...args) {
        console.log('ðŸ”— Auth popup opening with URL:', args[0]);
        const popup = originalOpen.apply(this, args);
        
        // Monitor popup
        if (popup) {
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              console.log('ðŸ”— Auth popup closed');
              clearInterval(checkClosed);
            }
          }, 1000);
        }
        
        return popup;
      };
    </script>
  </body>
</html>