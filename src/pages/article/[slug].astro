---
import { type CollectionEntry, getCollection } from "astro:content";
import { createHash } from "node:crypto";
import BlogLayout from "../../layouts/BlogLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import FeaturedCard from "../../components/FeaturedCard.astro";
import Carousel from "../../components/Carousel.astro";
import SocialShare from "../../components/SocialShare.astro";
import AdUnit from "../../components/AdUnit.astro";
import SiteOptions from "../../site.config.mjs";

// Define a union type for collections
type Post = CollectionEntry<"article"> | CollectionEntry<"submissions">;

// 1) Use getStaticPaths to generate a path for every article and submission
export async function getStaticPaths() {
  const articles = await getCollection("article");
  const submissions = await getCollection("submissions");
  const allContent = [...articles, ...submissions];

  return allContent.map((content) => ({
    params: { slug: content.slug },
    props: { post: content as Post }, // Pass the entire post object as a prop
  }));
}

// 2) The `post` prop is now available directly from the mapped paths
const { post } = Astro.props as { post: Post };

const {
  title,
  pubDate,
  category,
  description,
  thumb,
  author,
  tags,
  large,
  score,
  gallery,
} = post.data;
const { Content } = await post.render();

const titleLines = title.includes("|")
  ? title.split("|").map((line) => line.trim())
  : [title];

// 3) Fetch all posts for "You might also like" section
const allPosts = await getCollection("article");
const featuredPosts = allPosts
  .filter((p) => p.slug !== post.slug && p.data.featured)
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);
const dateObj = pubDate instanceof Date ? pubDate : new Date(pubDate);
const formattedDate = new Intl.DateTimeFormat("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
}).format(dateObj);
---

<BlogLayout title={title} description={description}>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={(thumb || large) ?? "/playtested.png"} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta
      name="twitter:image"
      content={(thumb || large) ?? "/playtested.png"}
    />
    <meta property="article:published_time" content={dateObj.toISOString()} />
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Article",
            "@id": `${Astro.url.href}#article`,
            headline: title,
            description: description,
            image: thumb || large ? [thumb || large] : undefined,
            datePublished: dateObj.toISOString(),
            dateModified: dateObj.toISOString(),
            author: [{ "@type": "Person", name: author }],
            mainEntityOfPage: { "@type": "WebPage", "@id": Astro.url.href },
            publisher: {
              "@type": "Organization",
              name: "PlayTested",
              url: Astro.url.origin,
            },
          },
          ...(typeof score !== "undefined" && score !== null
            ? [
                {
                  "@type": "Review",
                  headline: title,
                  description: description,
                  itemReviewed: {
                    "@type": "Game",
                    name: titleLines[0],
                  },
                  reviewRating: {
                    "@type": "Rating",
                    ratingValue: score,
                    bestRating: "10",
                    worstRating: "0",
                  },
                  author: { "@type": "Person", name: author },
                  publisher: { "@type": "Organization", name: "PlayTested" },
                  datePublished: dateObj.toISOString(),
                },
              ]
            : []),
        ],
      })}
    />
  </Fragment>

  <Header showTitle />

  <article class="relative mt-8">
    <div
      class="z-20 cursor-pointer transition-colors
             lg:bg-white lg:dark:bg-slate-800 lg:hover:bg-gray-50 lg:dark:hover:bg-slate-700
             lg:sticky lg:inset-x-0 lg:top-0"
      onclick="window.scrollTo({ top: 190, behavior: 'smooth' })"
    >
      <div
        class="w-full max-w-5xl mx-auto xl:mx-4 flex flex-col lg:flex-row items-center lg:items-start gap-1 lg:gap-4 py-2 md:py-4 mb-2 lg:mb-4 px-2 md:px-0 text-center lg:text-left leading-tight"
      >
        {
          typeof score !== "undefined" && score !== null && (
            <div class="shrink-0">
              <div class="article-score-badge beside-title mx-auto md:mx-0 scale-90 lg:scale-95 xl:scale-100">
                <span class="article-score-value text-base lg:text-lg xl:text-2xl">
                  {score}
                </span>
                <span class="article-score-label text-[10px] lg:text-xs xl:text-sm">
                  Score
                </span>
              </div>
            </div>
          )
        }
        <h1
          class="text-lg sm:text-xl lg:text-2xl xl:text-4xl font-semibold tracking-tight text-gray-900 dark:text-slate-100 leading-snug"
        >
          {
            titleLines.map((line, i) => (
              <>
                {line}
                {i < titleLines.length - 1 && <br />}
              </>
            ))
          }
        </h1>
      </div>
    </div>
    <div
      class="flex flex-col gap-1 mb-6 border-b pb-4 border-gray-200 dark:border-gray-700"
    >
      <div class="text-xl font-bold text-gray-800 dark:text-gray-100">
        By <a
          href={`/author/${author.toLowerCase().replace(/\s+/g, "-")}/`}
          class="hover:text-blue-600 hover:underline decoration-4 decoration-blue-500 underline-offset-4 transition-colors"
        >
          {author}
        </a>
      </div>

      <div class="text-sm text-gray-500 dark:text-gray-400">
        Published on {formattedDate}
        {
          category && (
            <span class="ml-2 px-2 py-0.5 bg-gray-100 dark:bg-slate-700 rounded text-xs uppercase tracking-wide font-semibold">
              {category}
            </span>
          )
        }
      </div>
    </div>
  </article>

  <div class="flex flex-wrap items-center justify-between gap-y-2 mb-6">
    {
      tags?.length > 0 ? (
        <div class="flex flex-wrap items-center gap-1 text-xs sm:text-sm">
          <span class="font-medium text-gray-500 dark:text-gray-400 mr-1">
            Tags:
          </span>
          {tags.map((tag) => (
            <a
              href={`/tag/${tag.toLowerCase().replace(/\s+/g, "-")}`}
              class="inline-block bg-gray-100 text-gray-600 dark:bg-slate-700 dark:text-slate-300 px-1.5 py-0.5 sm:px-4 sm:py-1 rounded hover:bg-gray-200 dark:hover:bg-slate-600 no-underline hover:underline text-[10px] sm:text-xs transition-colors"
            >
              {tag}
            </a>
          ))}
        </div>
      ) : (
        <div />
      )
    }

    <SocialShare
      title={title}
      description={description}
      thumb={thumb || large}
      score={score}
      author={author}
    />
  </div>
  {
    large && (
      <div class="mb-8 clear-both">
        <img
          src={large}
          alt={title}
          class="w-full h-auto rounded-lg shadow-md"
          loading="eager"
        />
      </div>
    )
  }

  <div
    class="pt-2 prose prose-h2:text-2xl prose-lg max-w-none text-gray-700 dark:prose-strong:text-slate-100 dark:text-gray-300 prose-headings:text-gray-900 dark:prose-headings:text-slate-100 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-code:text-slate-700 dark:prose-code:text-slate-100 prose-pre:bg-gray-100 dark:prose-pre:bg-slate-800 prose-blockquote:border-gray-300 dark:prose-blockquote:border-gray-600 prose-blockquote:text-gray-600 dark:prose-blockquote:text-gray-400 prose-h3:text-[1.2em]"
  >
    {/* AI Summary Section moved inside prose for alignment */}
    <button
      id="ai-summary-btn"
      class="mb-6 mt-4 py-2 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2 text-sm no-underline"
      data-slug={post.slug}
      data-author={author}
      data-hash={createHash("sha256")
        .update(post.body || "")
        .digest("hex")
        .substring(0, 16)}
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 10V3L4 14h7v7l9-11h-7z"></path>
      </svg>
      See AI Summary of Review
    </button>

    <div
      id="ai-summary-container"
      class="mb-6 mt-4 p-4 bg-blue-50 dark:bg-slate-800/50 rounded-lg border border-blue-100 dark:border-slate-700 hidden flow-root"
    >
      <h3
        class="font-bold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2 mt-0"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
            clip-rule="evenodd"></path>
        </svg>
        AI Summary
      </h3>
      <div
        id="ai-summary-text"
        class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed mt-3"
      >
      </div>
    </div>

    {
      Array.isArray(gallery) && gallery.length > 0 && (
        <div class="w-full lg:float-right lg:max-w-[420px] lg:ml-8 mb-6 lg:mb-4">
          <Carousel images={gallery} />
        </div>
      )
    }

    <Content />

    <div class="mt-8 mb-4">
      <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">
        Share this review
      </h3>
      <SocialShare
        title={title}
        description={description}
        thumb={thumb || large}
        score={score}
        author={author}
      />
    </div>

    <section id="comments" class="mt-12">
      <script
        src="https://giscus.app/client.js"
        data-repo="lyndon025/playtested"
        data-repo-id="R_kgDOPaOyuA"
        data-category="comments"
        data-category-id="DIC_kwDOPaOyuM4CuBy3"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async></script>
    </section>
  </div>
</BlogLayout>

{
  SiteOptions.showSimilarPosts && featuredPosts.length > 0 && (
    <>
      <hr class="border-t border-gray-200 dark:border-gray-700 my-12" />
      <section>
        <h2 class="text-2xl font-semibold mb-8 text-center text-gray-800 dark:text-slate-200">
          {SiteOptions.labels.youMightAlsoLike}
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
          {featuredPosts.map((p) => (
            <FeaturedCard post={p} />
          ))}
        </div>
      </section>
    </>
  )
}

<Footer />

<script define:vars={{ rawBody: post.body || "" }}>
  function initAiSummary() {
    console.log("AI Summary: Init called");
    const btn = document.getElementById("ai-summary-btn");
    const container = document.getElementById("ai-summary-container");
    const summaryText = document.getElementById("ai-summary-text");

    // Helper to format text
    const formatText = (text) => {
      if (!text) return "";
      return text
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(/\n\n/g, "<br><br>")
        .replace(/\n/g, "<br>");
    };

    if (btn) {
      // Remove old listener to prevent duplicates if any (though unlikely with fresh init)
      // Actually, cloning/replacing node is safer but let's just add listener.
      // Since page reloads entirely or view transition swaps body, new Button = new Listener.
      console.log("AI Summary: Button found. Attaching listener.");

      btn.onclick = async () => {
        console.log("AI Summary: Clicked.");
        // Loading state
        const originalContent = btn.innerHTML;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating...
        `;
        btn.disabled = true;

        try {
          const slug = btn.dataset.slug;
          const hash = btn.dataset.hash;
          const author = btn.dataset.author || "lyndonguitar";
          console.log("AI Summary: Sending request", slug, hash, author);

          const res = await fetch("/api/summary", {
            method: "POST",
            body: JSON.stringify({ slug, hash, text: rawBody, author }),
            headers: { "Content-Type": "application/json" },
          });

          if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.error || "Failed to generate summary");
          }
          const data = await res.json();
          console.log("AI Summary: Success", data);

          // Hide button, show summary
          btn.classList.add("hidden");
          container.classList.remove("hidden");
          summaryText.innerHTML = formatText(data.summary);
        } catch (e) {
          console.error("AI Summary Error:", e);
          btn.innerHTML = originalContent;
          btn.disabled = false;
          alert(e.message);
        }
      };
    } else {
      console.log("AI Summary: Button NOT found.");
    }
  }

  // Run on initial load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAiSummary);
  } else {
    initAiSummary();
  }

  // Run on Client Router navigation
  document.addEventListener("astro:page-load", initAiSummary);
</script>

<script is:inline define:vars={{ ads: SiteOptions.ads }}>
  function injectAds() {
    if (!ads.adSense.enabled && !ads.carbonAds.enabled && !ads.adsterra.enabled)
      return;

    const articleBody = document.querySelector(".prose");
    if (!articleBody) return;

    // Remove existing ad containers to avoid duplicates on navigation
    articleBody
      .querySelectorAll(".in-article-ad-wrapper")
      .forEach((el) => el.remove());

    const paragraphs = Array.from(articleBody.children).filter(
      (el) => el.tagName === "P",
    );

    // Inject after 3rd paragraph or in the middle
    if (paragraphs.length >= 4) {
      const targetIndex = Math.floor(paragraphs.length / 2);
      const targetP = paragraphs[targetIndex];

      const adWrapper = document.createElement("div");
      adWrapper.className = "in-article-ad-wrapper my-8";

      // We create a placeholder that the AdUnit logic can use or just inject script here
      // For simplicity and to avoid complex Astro/Client-Side mixing, we'll use a hidden template or specialized injection
      if (ads.adSense.enabled) {
        adWrapper.innerHTML = `
          <ins class="adsbygoogle"
               style="display:block; text-align:center;"
               data-ad-layout="in-article"
               data-ad-format="fluid"
               data-ad-client="${ads.adSense.clientId}"
               data-ad-slot="${ads.adSense.articleUnitId}"></ins>
        `;
        targetP.insertAdjacentElement("afterend", adWrapper);
        (window.adsbygoogle = window.adsbygoogle || []).push({});
      } else if (ads.adsterra.enabled && ads.adsterra.nativeBannerEnabled) {
        adWrapper.innerHTML = `
          <div id="container-${ads.adsterra.nativeBannerId}"></div>
        `;
        const script = document.createElement("script");
        script.async = true;
        script.dataset.cfasync = "false";
        script.src = `https://pl28747193.effectivegatecpm.com/${ads.adsterra.nativeBannerId}/invoke.js`;
        adWrapper.appendChild(script);
        targetP.insertAdjacentElement("afterend", adWrapper);
      }
    }
  }

  document.addEventListener("astro:page-load", injectAds);
  injectAds();
</script>
